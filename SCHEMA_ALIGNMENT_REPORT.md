# USAC RHC Automation - Schema Alignment Report

**Date:** November 9, 2025
**Status:** CRITICAL ISSUES IDENTIFIED
**Workflow:** Main Daily Workflow V2 (Phase 2)
**Database:** Supabase (fhuqiicgmfpnmficopqp.supabase.co)

---

## EXECUTIVE SUMMARY

The n8n workflow is broken because it tries to insert the `application_number` field, which **DOES NOT EXIST** in the Supabase database schema. Additionally, there are several missing fields and data type mismatches that need to be resolved.

### Root Cause
- Workflow evolved over time with additional fields
- Database schema (schema.sql + schema_update_v2.sql) was partially applied
- `application_number` field was added to workflow but never added to database
- Missing fields for USAC API data (zip, contact_phone, etc.)

---

## PART 1: CURRENT SUPABASE SCHEMA

### Verified Columns in `clinics_pending_review` Table

Based on live query to Supabase (November 9, 2025):

```sql
-- Core columns (from schema.sql)
id                              uuid PRIMARY KEY
hcp_number                      text NOT NULL
clinic_name                     text NOT NULL
address                         text
city                            text
state                           text NOT NULL
filing_date                     timestamptz NOT NULL
form_465_hash                   text UNIQUE NOT NULL
service_type                    text
contract_length                 integer
bandwidth                       text
priority_score                  integer
priority_label                  text
total_funding_3y                numeric(12, 2)
location_count                  integer DEFAULT 1
participation_years             integer
enriched                        boolean DEFAULT false
contact_name                    text
contact_title                   text
contact_email                   text
clinic_website                  text
linkedin_url                    text
enrichment_date                 timestamptz
processed                       boolean DEFAULT false
assigned_to                     text
email_draft_created             boolean DEFAULT false
notes                           text
created_at                      timestamptz DEFAULT now()
updated_at                      timestamptz DEFAULT now()

-- Phase 2 columns (from schema_update_v2.sql)
is_consultant                   boolean DEFAULT false
consultant_company              text
consultant_email_domain         text
consultant_detection_method     text
funding_year_1                  integer
funding_amount_1                numeric(12, 2)
funding_year_2                  integer
funding_amount_2                numeric(12, 2)
funding_year_3                  integer
funding_amount_3                numeric(12, 2)
form_465_pdf_url                text
posting_date                    date
allowable_contract_start_date   date
program_type                    text
mail_contact_name               text
mail_contact_email              text
mail_contact_company            text
description_of_services         text
```

**Total Columns:** 48

---

## PART 2: N8N WORKFLOW FIELD MAPPINGS

### Fields Generated by "Process & Extract All Fields" Node

From the JavaScript code in the workflow:

```javascript
const processed = {
  // Core identifiers
  hcp_number: data.hcp_number || data.health_care_provider_number,
  application_number: data.application_number || data.form_465_application_number,  // ‚ùå DOES NOT EXIST
  form_465_hash: hash,

  // Clinic information
  clinic_name: data.site_name || data.health_care_provider_name,
  address: data.site_address || data.service_delivery_site_physical_address,
  city: data.site_city || data.service_delivery_site_city,
  state: data.site_state || data.service_delivery_site_state,
  zip: data.site_zip || data.site_zip_code,  // ‚ùå DOES NOT EXIST

  // Contact information
  contact_name: data.contact_person_name || data.contact_name,
  contact_title: data.contact_person_title || data.contact_title,
  contact_email: contactEmail,
  contact_phone: data.contact_phone_number || data.contact_telephone_number,  // ‚ùå DOES NOT EXIST

  // Mail contact (potentially consultant)
  mail_contact_name: data.mail_contact_name || data.mailing_contact_name,
  mail_contact_email: mailContactEmail,
  mail_contact_company: data.mail_contact_company || data.mailing_contact_company,

  // Consultant detection
  is_consultant: isConsultant,
  consultant_company: isConsultant ? (data.mail_contact_company || data.mailing_contact_company) : null,
  consultant_email_domain: isConsultant ? mailDomain : null,
  consultant_detection_method: isConsultant ? 'auto_domain' : null,

  // Dates
  posting_date: data.posting_date,
  filing_date: data.form_465_date_certified || data.posting_date,
  allowable_contract_start_date: data.allowable_contract_date,

  // Program information
  program_type: 'Telecom',
  service_type: data.service_type || data.type_of_service,
  description_of_services: data.narrative_description || data.description,

  // Contract details
  contract_length: data.contract_term_months || null,
  bandwidth: data.bandwidth_mbps || null,

  // PDF URL
  form_465_pdf_url: data.application_number ? `https://rhc.usac.org/rhc/public/viewPdf.seam?documentId=${data.application_number}` : null,

  // Status
  processed: false,
  created_at: new Date().toISOString()
};
```

---

## PART 3: USAC API FIELDS (from Phase1_Workflow_Outline.md)

### Expected Fields from USAC Form 465 API

```
Core Fields:
- Funding Year
- HCP Number
- HCP Name
- Application Type
- Site Address Line 1
- Site City
- Site State
- Site Zip Code
- Contact First Name
- Contact Last Name
- Contact Phone
- Contact Email
- Allowable Contract Start Date
- Requested Contract Period
- Link to FCC Form PDF
- Mail Contact First Name
- Mail Contact Last Name
- Mail Contact Org Name
- Mail Contact Phone
- Mail Contact Email
- Descriptions of Services Requested

Document Links (should be stored as JSONB array):
- RFP 1-10
- Additional Document 1-10
```

---

## PART 4: CRITICAL COLUMN MISMATCHES

### ‚ùå Fields in Workflow BUT NOT in Database

| Workflow Field | Why Missing | Impact |
|---------------|-------------|---------|
| `application_number` | Never added to schema | **BLOCKING** - Causes insert to fail |
| `zip` | Not in schema.sql or schema_update_v2.sql | Data loss - zip code not stored |
| `contact_phone` | Not in schema.sql or schema_update_v2.sql | Data loss - phone number not stored |
| `created_at` (workflow) | Conflicts with DB default | Minor - DB handles this |

### ‚ö†Ô∏è Fields in Database BUT NOT in Workflow

| Database Field | Why Missing | Impact |
|---------------|-------------|---------|
| `clinic_website` | Enrichment field only | Low - filled later |
| `linkedin_url` | Enrichment field only | Low - filled later |
| `location_count` | Not extracted from API | Low - defaults to 1 |
| `participation_years` | Not calculated yet | Medium - useful for scoring |
| `assigned_to` | Dashboard feature | Low - manual field |
| `email_draft_created` | Dashboard feature | Low - manual field |
| `notes` | Dashboard feature | Low - manual field |

### üìã Document Links Issue

**USAC API provides:**
- RFP 1, RFP 2, ... RFP 10 (10 separate fields)
- Additional Document 1, ... Additional Document 10 (10 separate fields)

**Current Schema:** No storage for these 20 document links

**Recommended Solution:** Add `additional_documents JSONB` column to store as array:
```json
{
  "rfp_links": ["url1", "url2", ...],
  "additional_docs": ["url1", "url2", ...]
}
```

---

## PART 5: SQL MIGRATION SCRIPT

### Required Schema Changes

```sql
-- =============================================
-- USAC RHC Automation - Schema Alignment Fix
-- =============================================
-- Date: 2025-11-09
-- Purpose: Add missing columns to match n8n workflow
-- =============================================

-- Step 1: Add missing core fields
ALTER TABLE public.clinics_pending_review
ADD COLUMN IF NOT EXISTS application_number text,
ADD COLUMN IF NOT EXISTS zip text,
ADD COLUMN IF NOT EXISTS contact_phone text;

-- Step 2: Add document storage (JSONB for flexible array storage)
ALTER TABLE public.clinics_pending_review
ADD COLUMN IF NOT EXISTS additional_documents jsonb DEFAULT '{"rfp_links": [], "additional_docs": []}'::jsonb;

-- Step 3: Add indexes for new searchable fields
CREATE INDEX IF NOT EXISTS idx_clinics_application_number
  ON public.clinics_pending_review(application_number);

CREATE INDEX IF NOT EXISTS idx_clinics_zip
  ON public.clinics_pending_review(zip);

-- Step 4: Add comments for documentation
COMMENT ON COLUMN public.clinics_pending_review.application_number IS
  'Form 465 Application Number from USAC (e.g., RHC46500001741)';

COMMENT ON COLUMN public.clinics_pending_review.zip IS
  'ZIP code of service delivery site';

COMMENT ON COLUMN public.clinics_pending_review.contact_phone IS
  'Primary contact phone number';

COMMENT ON COLUMN public.clinics_pending_review.additional_documents IS
  'JSONB array of document links: {"rfp_links": [...], "additional_docs": [...]}';

-- Step 5: Validate existing data (optional check)
-- This will show if any test records exist that need cleaning
SELECT
  hcp_number,
  clinic_name,
  created_at,
  CASE
    WHEN application_number IS NULL THEN 'MISSING'
    ELSE 'OK'
  END as app_num_status
FROM public.clinics_pending_review
ORDER BY created_at DESC
LIMIT 10;

-- =============================================
-- Migration Complete
-- =============================================
```

---

## PART 6: N8N WORKFLOW FIXES NEEDED

### Fix 1: Update "Process & Extract All Fields" Node

**Current Code (lines ~30-32):**
```javascript
hcp_number: data.hcp_number || data.health_care_provider_number,
application_number: data.application_number || data.form_465_application_number,  // Keep this now
form_465_hash: hash,
```

**Add after line ~37 (after state):**
```javascript
zip: data.site_zip || data.site_zip_code,  // Add zip field
```

**Add after line ~42 (after contact_email):**
```javascript
contact_phone: data.contact_phone_number || data.contact_telephone_number,  // Add phone
```

**Add AFTER the existing fields (before the final `};`):**
```javascript
// Additional documents (combine RFP 1-10 and Additional Doc 1-10)
additional_documents: {
  rfp_links: [
    data.rfp_1, data.rfp_2, data.rfp_3, data.rfp_4, data.rfp_5,
    data.rfp_6, data.rfp_7, data.rfp_8, data.rfp_9, data.rfp_10
  ].filter(link => link && link.trim() !== ''),
  additional_docs: [
    data.additional_document_1, data.additional_document_2, data.additional_document_3,
    data.additional_document_4, data.additional_document_5, data.additional_document_6,
    data.additional_document_7, data.additional_document_8, data.additional_document_9,
    data.additional_document_10
  ].filter(link => link && link.trim() !== '')
},
```

### Fix 2: Verify Field Mapping in Insert Nodes

**Node: "Insert into Supabase1" (position [96,-768])**

This node uses `JSON.stringify($json)` which should automatically include all fields. No changes needed, but verify after schema update.

**Node: "Create a row" (Supabase native node)**

This node might need to be reconfigured to map the new fields. After schema update:
1. Open the node
2. Click "Refresh Fields" or similar
3. Verify all fields are mapped correctly

---

## PART 7: STEP-BY-STEP IMPLEMENTATION PLAN

### Phase 1: Database Migration (15 minutes)

1. **Backup Current Data**
   ```bash
   # Export existing test record
   curl -X GET "https://fhuqiicgmfpnmficopqp.supabase.co/rest/v1/clinics_pending_review" \
     -H "apikey: [ANON_KEY]" \
     -H "Authorization: Bearer [SERVICE_KEY]" \
     > backup_before_migration.json
   ```

2. **Run Migration Script**
   - Open Supabase Dashboard ‚Üí SQL Editor
   - Copy migration script from Part 5
   - Execute
   - Verify no errors

3. **Reload Schema Cache**
   - Supabase Dashboard ‚Üí Settings ‚Üí API
   - Click "Reload Schema" button
   - Wait 30 seconds

4. **Verify New Columns**
   ```bash
   # Test query to verify columns exist
   curl -X GET "https://fhuqiicgmfpnmficopqp.supabase.co/rest/v1/clinics_pending_review?limit=1" \
     -H "apikey: [ANON_KEY]" \
     -H "Authorization: Bearer [SERVICE_KEY]"
   # Should return JSON with application_number, zip, contact_phone, additional_documents fields
   ```

### Phase 2: Update n8n Workflow (20 minutes)

1. **Open Workflow in n8n Cloud**
   - Go to https://hyamie.app.n8n.cloud/
   - Open "USAC RHC - Main Daily Workflow V2 (Phase 2)"

2. **Update "Process & Extract All Fields" Node**
   - Find the node (position [-896,-800])
   - Click to edit
   - Apply changes from Fix 1 above
   - Save node

3. **Update "Process & Extract All Fields1" Node** (duplicate)
   - Find the node (position [-912,-512])
   - Apply same changes
   - Save node

4. **Verify Supabase Nodes**
   - "Create a row" node ‚Üí Click "Refresh Fields"
   - "Insert into Supabase1" node ‚Üí No changes needed (uses JSON.stringify)
   - "HTTP Request" insert nodes ‚Üí No changes needed

5. **Save Workflow**
   - Click Save button
   - Export workflow JSON for backup

### Phase 3: Testing (30 minutes)

1. **Test with Manual Execution**
   - Click "Execute Workflow" button
   - Check pinned test data processes correctly
   - Verify no errors in execution log

2. **Verify Data in Supabase**
   ```bash
   # Check if new test record was inserted
   curl -X GET "https://fhuqiicgmfpnmficopqp.supabase.co/rest/v1/clinics_pending_review?order=created_at.desc&limit=1" \
     -H "apikey: [ANON_KEY]" \
     -H "Authorization: Bearer [SERVICE_KEY]"
   ```
   - Verify `application_number` is populated
   - Verify `zip` is populated
   - Verify `contact_phone` is populated
   - Verify `additional_documents` is valid JSON

3. **Test with Live USAC API**
   - Temporarily change schedule trigger to run immediately
   - Execute workflow
   - Check Supabase for new records
   - Verify all fields populated correctly

4. **Clean Up Test Data**
   ```sql
   -- Delete test records if needed
   DELETE FROM clinics_pending_review
   WHERE hcp_number LIKE 'TEST%' OR clinic_name LIKE '%Test%';
   ```

### Phase 4: Documentation & Commit (10 minutes)

1. **Update Documentation**
   - Mark HANDOFF_2025-11-08_NIGHT.md as resolved
   - Update database/schema.sql with new columns
   - Create schema_update_v3.sql with this migration

2. **Export Workflow**
   ```bash
   curl -X GET "https://hyamie.app.n8n.cloud/api/v1/workflows/6Pv9uvzKec5xInWS" \
     -H "X-N8N-API-KEY: [API_KEY]" \
     > workflows/main_daily_workflow_v2_FIXED.json
   ```

3. **Commit to Git**
   ```bash
   cd C:\ClaudeAgents\projects\usac-rhc-automation
   git add .
   git commit -m "fix(schema): align database with n8n workflow fields

   - Add application_number, zip, contact_phone columns
   - Add additional_documents JSONB for document links
   - Update workflow to populate all new fields
   - Fix PGRST204 schema mismatch error

   Resolves: Phase 1 schema alignment issue"
   ```

---

## PART 8: VALIDATION CHECKLIST

### Pre-Migration Checks
- [ ] Backed up current Supabase data
- [ ] Exported current n8n workflow
- [ ] Reviewed migration script for errors
- [ ] Confirmed Supabase credentials are correct

### Post-Migration Checks
- [ ] Migration script executed successfully
- [ ] Schema cache reloaded in Supabase
- [ ] New columns visible in Supabase Table Editor
- [ ] Test record can be inserted manually

### Post-Workflow Update Checks
- [ ] n8n workflow updated and saved
- [ ] Workflow executes without errors
- [ ] Data appears in Supabase correctly
- [ ] All fields populated (application_number, zip, contact_phone)
- [ ] additional_documents JSONB is valid
- [ ] No PGRST204 errors in logs

### Production Readiness Checks
- [ ] Documentation updated
- [ ] Workflow exported and backed up
- [ ] Git commit created
- [ ] Test data cleaned up
- [ ] Ready for daily scheduled execution

---

## PART 9: EXPECTED OUTCOMES

### Before Fix
```
ERROR: PGRST204 - Column 'application_number' not found in schema cache
Status: 400 Bad Request
Result: Workflow fails, no data inserted
```

### After Fix
```
SUCCESS: Record inserted successfully
Status: 201 Created
Result: Workflow completes, data in Supabase with all fields populated
Example Record:
{
  "hcp_number": "50472",
  "application_number": "RHC46500001741",  ‚Üê NOW POPULATED
  "clinic_name": "Honesdale Family Health Center",
  "zip": "18431-1459",  ‚Üê NOW POPULATED
  "contact_phone": "(570) 123-4567",  ‚Üê NOW POPULATED
  "additional_documents": {  ‚Üê NOW POPULATED
    "rfp_links": ["http://example.com/rfp1.pdf"],
    "additional_docs": ["http://example.com/doc1.pdf"]
  }
  ...
}
```

---

## PART 10: RISK ASSESSMENT

### Low Risk
- Adding new nullable columns (no data loss)
- Adding JSONB column with default value
- Schema cache reload (automatic, no downtime)

### Medium Risk
- Workflow changes (could introduce new bugs)
- Field mapping changes (need thorough testing)

### Mitigation
- Test with pinned data before live execution
- Keep backup of working workflow JSON
- Can rollback schema changes if needed (columns are nullable)
- Git commit allows reverting changes

---

## APPENDIX A: Quick Reference

### Supabase URLs
- Dashboard: https://app.supabase.com/project/fhuqiicgmficopqp
- API Base: https://fhuqiicgmfpnmficopqp.supabase.co/rest/v1
- Table Editor: https://app.supabase.com/project/fhuqiicgmficopqp/editor

### n8n URLs
- Dashboard: https://hyamie.app.n8n.cloud/
- Workflow: https://hyamie.app.n8n.cloud/workflow/6Pv9uvzKec5xInWS

### Key Files
- Schema: `database/schema.sql`, `database/schema_update_v2.sql`
- Workflow Export: `workflows/main_daily_workflow_v2_export.json`
- This Report: `SCHEMA_ALIGNMENT_REPORT.md`

---

## APPENDIX B: Data Type Reference

### USAC API ‚Üí Database Mapping

| USAC Field | API Type | Database Column | DB Type | Notes |
|-----------|----------|----------------|---------|-------|
| application_number | string | application_number | text | NEW - Form 465 ID |
| hcp_number | string | hcp_number | text | Existing |
| site_name | string | clinic_name | text | Existing |
| site_zip_code | string | zip | text | NEW |
| contact_phone_number | string | contact_phone | text | NEW |
| posting_date | ISO date | posting_date | date | Existing |
| rfp_1...rfp_10 | string URLs | additional_documents | jsonb | NEW - array |
| additional_document_1...10 | string URLs | additional_documents | jsonb | NEW - array |

---

**End of Report**

**Next Action:** Run Part 7 (Implementation Plan) step by step.
