{
  "id": "6Pv9uvzKec5xInWS",
  "name": "USAC RHC - Main Daily Workflow V2 (Phase 2)",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Function to collect document links from 20 separate USAC columns\nfunction collectDocumentLinks(data) {\n  const rfpLinks = [];\n  const additionalDocs = [];\n\n  // Collect RFP links (RFP 1-10)\n  for (let i = 1; i <= 10; i++) {\n    const rfpLink = data[`rfp_${i}`] || data[`RFP_${i}`] || data[`rfp${i}`];\n    if (rfpLink && rfpLink.trim() !== '') {\n      rfpLinks.push(rfpLink.trim());\n    }\n  }\n\n  // Collect Additional Document links (1-10)\n  for (let i = 1; i <= 10; i++) {\n    const docLink = data[`additional_document_${i}`] || data[`Additional_Document_${i}`] || data[`additional_doc_${i}`];\n    if (docLink && docLink.trim() !== '') {\n      additionalDocs.push(docLink.trim());\n    }\n  }\n\n  return {\n    rfp_links: rfpLinks,\n    additional_docs: additionalDocs\n  };\n}\n\n// Process USAC API response and extract all fields\nconst filings = $input.all();\nconst processedFilings = [];\n\nfor (const filing of filings) {\n  const data = filing.json;\n  \n  // Extract contact information\n  const contactEmail = data.contact_email_address || '';\n  const mailContactEmail = data.mail_contact_email || '';\n  const contactDomain = contactEmail.split('@')[1] || '';\n  const mailDomain = mailContactEmail.split('@')[1] || '';\n  \n  // Consultant detection logic\n  const isConsultant = contactDomain !== mailDomain && mailDomain !== '';\n  \n  // Generate deduplication hash\n  const crypto = require('crypto');\n  const hashString = `${data.hcp_number}-${data.posting_date}-${data.site_name}-${data.site_address}`;\n  const hash = crypto.createHash('sha256').update(hashString).digest('hex');\n  \n  // Build processed filing object with all Phase 2 fields\n  const processed = {\n    // Core identifiers\n    hcp_number: data.hcp_number || data.health_care_provider_number,\n    application_number: data.application_number || data.form_465_application_number,\n    form_465_hash: hash,\n    \n    // Clinic information\n    clinic_name: data.site_name || data.health_care_provider_name,\n    address: data.site_address || data.service_delivery_site_physical_address,\n    city: data.site_city || data.service_delivery_site_city,\n    state: data.site_state || data.service_delivery_site_state,\n    zip: data.site_zip || data.site_zip_code,\n    \n    // Contact information\n    contact_name: data.contact_person_name || data.contact_name,\n    contact_title: data.contact_person_title || data.contact_title,\n    contact_email: contactEmail,\n    contact_phone: data.contact_phone_number || data.contact_telephone_number,\n    \n    // Mail contact (potentially consultant)\n    mail_contact_name: data.mail_contact_name || data.mailing_contact_name,\n    mail_contact_email: mailContactEmail,\n    mail_contact_company: data.mail_contact_company || data.mailing_contact_company,\n    \n    // Consultant detection\n    is_consultant: isConsultant,\n    consultant_company: isConsultant ? (data.mail_contact_company || data.mailing_contact_company) : null,\n    consultant_email_domain: isConsultant ? mailDomain : null,\n    consultant_detection_method: isConsultant ? 'auto_domain' : null,\n    \n    // Dates\n    posting_date: data.posting_date,\n    filing_date: data.form_465_date_certified || data.posting_date,\n    allowable_contract_start_date: data.allowable_contract_date,\n    \n    // Program information\n    program_type: 'Telecom',\n    service_type: data.service_type || data.type_of_service,\n    description_of_services: data.narrative_description || data.description,\n    \n    // Contract details\n    contract_length: data.contract_term_months || null,\n    bandwidth: data.bandwidth_mbps || null,\n    \n    // Document links (JSONB) - NEW\n    additional_documents: collectDocumentLinks(data),\n    \n    // PDF URL\n    form_465_pdf_url: data.application_number ? `https://rhc.usac.org/rhc/public/viewPdf.seam?documentId=${data.application_number}` : null,\n    \n    // Status\n    processed: false,\n    created_at: new Date().toISOString()\n  };\n  \n  processedFilings.push({ json: processed });\n}\n\nreturn processedFilings;"
      },
      "name": "Process & Extract All Fields1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -912,
        -512
      ],
      "id": "330397b1-c043-48a8-b031-558be4556a5e"
    }
  ]
}
